name: Copilot Guardrails

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Block obvious secrets
        run: |
          set -e
          echo "Scanning for common secret patterns..."
          # Look for actual secret values (sk-, hf_, ghp_, etc.) not just variable names
          ! grep -RInE "(OPENAI_API_KEY|HF_TOKEN|HF_WRITE_TOKEN|HUGGINGFACE_TOKEN|GITHUB_TOKEN)\s*=\s*['\"]?(sk-|hf_|ghp_|Bearer\s+[A-Za-z0-9])" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude-dir=.history \
            --exclude-dir=.snapshots \
            --exclude="*.example*" \
            --exclude=".env.example" \
            --exclude="api_keys.example.json" \
            --exclude="copilot-guard.yml" \
            || (echo "❌ Secret-like pattern found" && exit 1)
          echo "✅ No secrets detected"

      - name: Warn on dependency drift
        run: |
          set -e
          echo "Checking dependency file changes..."
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|requirements\.txt|poetry\.lock)"; then
            echo "⚠️  Dependency files changed. Ensure Task Spec allows it."
            echo "Changed dependency files:"
            git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|requirements\.txt|poetry\.lock)" || true
          else
            echo "✅ No dependency files changed"
          fi

      - name: Ensure PR is focused
        run: |
          set -e
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l | tr -d ' ')
          echo "Files changed: $CHANGED"
          if [ "$CHANGED" -gt 60 ]; then
            echo "❌ Too many files changed ($CHANGED > 60). Split PR into smaller concerns."
            exit 1
          fi
          echo "✅ PR has focused scope ($CHANGED files)"

      - name: Check for TODO placeholders
        run: |
          set -e
          echo "Checking for TODO placeholders in changed files..."
          TODOS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO" | grep -v "copilot-guard.yml" || true)
          if [ -n "$TODOS" ]; then
            echo "⚠️  TODO placeholders found in changes:"
            echo "$TODOS"
            echo "Ensure Task Spec allows TODO placeholders"
          else
            echo "✅ No TODO placeholders found"
          fi
